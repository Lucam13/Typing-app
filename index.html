<title> Typing app </title>

<style> 
    :root {
        color-scheme: light dark;
        --green: #00b755;
        --yellow: #daaf38;
        --red: #ca4754;
        --black: #222;
        --gray: #999;
    }

    body {
        background: var(--black);
        font-family: Menlo, monospace;
        display:grid;   
        padding: 32px;
        justify-content: center;
        margin-top: 32px;
        padding: 16px;
    }

    section {
        padding: 16px;   
        display: flex;
        flex-direction: column;
        gap: 4px;
        max-width: 500px;
    }

    time {
        color: var(--yellow)
    }

    input {
        z-index: -999;
        position: absolute;
        top:0;
        left:0;
        pointer-events: none;
        opacity: 0;
    }

    p {
        display: flex;
        flex-wrap: wrap;
        gap: 3px 8px;
        margin:0;
    }

    letter {
        color: var(--gray);
        position: relative;

        &.active::before {
            content: '|';
            color: var(--yellow);
            font-size: 14px;
            position: absolute;
            left: -65%;
            animation: 1s blink infinite ease-in-out;

        }
        

        &.active.is-last::before {
           left: 65%
        }

        &.correct {
            color: var(--green);
        }
        &.incorrect {
            color: var(--red);
        }
    }


    @keyframes blink {
            0%, 25% {
                opacity: 1;
            }
            75% {
                opacity: 0;
            }
        }    


    word {
        border-bottom: 1.5px solid transparent;
        transition: border-color 0.3s ease-in-out;
        &.marked {
            border-color: var(--red);
        }
    }

    #game {
        display: flex;
    }

    #results {
        display: none;
    }   
</style>

<body>
    <main> 
        <section id="game">
            <time></time>
            <p></p>
            <input autofocus>
        </section>
        <section id="results">
            <h2>wmp</h2>
            <h3></h3>

            <h2>Accuracy</h2>
            <h3></h3>
        </section>
    </main>
</body>

<script type="module" >
    import { words as INITIAL_WORDS } from './data.js'

    const time = document.querySelector('time');
    const paragraph = document.querySelector('p');
    const input = document.querySelector('input');
    const game = document.querySelector('#game');
    const results = document.querySelector('#results');
    const wpm = results.querySelector('h2');
    const accuracy = results.querySelector('h3: last-child');

    const INITIAL_TIME = 3;

    
    let words = []
    let currentTime = INITIAL_TIME;

// puedo declarar una funcion y llamarla en el momento que la necesite, por que este antes por que la invocacion esta en todo el scope.


    initGame()
    initEvents()

    function initGame(){
        words = INITIAL_WORDS.toSorted(() => Math.random() - 0.5).slice(0, 32)
        currentTime = INITIAL_TIME;

        time.textContent = currentTime;

        paragraph.innerHTML = words.map((word, index) =>{
            const letters = word.split('');

            return ` <word>
                ${
                    letters.map(letter => `<letter>${letter}</letter>`).join('')
                }
                
                </word>
                `
        }).join('')

        
        const firstWord = paragraph.querySelector('word')
        firstWord.classList.add('active')
        firstWord.querySelector('letter').classList.add('active')


        const intervalId = setInterval(() => {
            currentTime--
            time.textContent = currentTime;

            if (currentTime === 0) {
                clearInterval(intervalId)
                gameOver()
            }
        }, 1000)

    }

    function initEvents() {
        document.addEventListener('keydown', () => {
            input.focus()
        })
        input.addEventListener('keydown', onKeyDown)
        input.addEventListener('keyup', onKeyUp)
    }

    function onKeyDown(event) {
        const currentWord = paragraph.querySelector('word.active')
        const currentLetter = currentWord.querySelector('letter.active')

        const { key } = event
        if (key === ' ') {
            event.preventDefault()

            const nextWord = currentWord.nextElementSibling
            const nextLetter =nextWord.querySelector('letter')

            currentWord.classList.remove('active', 'marked')
            currentLetter.classList.remove('active')

            nextWord.classList.add('active')
            nextLetter.classList.add('active')

            input.value = ''

            const hasMissedLetters = currentWord.querySelectorAll('letter:not(.correct)').length > 0 

            const classToAdd = hasMissedLetters ? 'marked' : 'correct'
            currentWord.classList.add(classToAdd)

        }

        if (key === 'Backspace') {
            const prevWord = currentWord.previousElementSibling
            const prevLetter = currentLetter.previousElementSibling

            if(!prevWord && !prevLetter) 
            event.preventDefault()
            return
        }

        const wordMarked = paragraph.querySelector('word.marked')
        if (!prevLetter && !wordMarked) {
            event.preventDefault()
            prevWord.classList.remove('marked')
            prevWord.classList.add('active')

            const letterToGo = prevWord.querySelector('letter:last-child')

            currentLetter.classList.remove('active')
            letterToGo.classList.add('active')

            input.value = [
                ...prevWord.querySelectorAll('letter.correct, letter.incorrect')
                ].map(el =>{
                    return el.classList.contains('corrent') ? el.innerText : '*'
                }).join('')       
                    
        }

    }

    function onKeyUp() {
        const currentWord = paragraph.querySelector('word.active')
        const currentLetter = currentWord.querySelector('letter.active')

        const presentWord = currentWord.innerText.trim()
        input.maxLength = presentWord.length
        console.log({value : input.value, presentWord})

        const allLetters = currentWord.querySelectorAll('letter')

        allLetters.forEach(letter => letter.classList.remove('correct', 'incorrect'))

        input.value.split('').forEach((char, index) => {
            const letter = allLetters[index]
            const letterToCheck = presentWord[index]

            const isCorrect = char === letterToCheck
            const letterClass = isCorrect ? 'correct' : 'incorrect'
            letter.classList.add(letterClass)
        })

        currentLetter.classList.remove('active', 'is-last')
        const inputLength = input.value.length;
        const nextActiveLetter = allLetters[inputLength]

        if(nextActiveLetter) {
            nextActiveLetter.classList.add('active')
        } else {
            currentLetter.classList.add('active', 'is-last')
        }
        
    }



    function gameOver(){
        
    }



</script>